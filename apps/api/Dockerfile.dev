FROM node:20
WORKDIR /app
ENV PNPM_HOME=/root/.local/share/pnpm
ENV PATH=$PNPM_HOME:$PATH
RUN corepack enable

# Pre-copy lockfiles for better caching; source is bind-mounted at runtime
COPY pnpm-lock.yaml package.json pnpm-workspace.yaml tsconfig.base.json ./
# Include workspace package manifests needed for api install
COPY apps/api/package.json apps/api/package.json
COPY packages/contracts/ packages/contracts/
COPY packages/core/ packages/core/
RUN pnpm install --frozen-lockfile=false

# @dealdecision/core has "main": dist/index.js; build it so runtime imports work
RUN pnpm --filter @dealdecision/core build

CMD ["pnpm", "--filter", "api", "dev"]
